<html>
    <head>
        <title>Untapped</title>
        <style>
            div {
                padding: 5px;
            }
            table.timetable {
                border: solid 1px black;
                border-spacing: 0;
                width: 100%;
            }
            .timetable td,th {
                border: solid 1px;
            }
            #teacherLookup {
                border: darkred solid 1px;
            }
        </style>
    </head>
    <body>
        <div id="loginshizzle">
            <div>
                <label for="username">Username:</label>
                <input type="text" id="untisuser" name="username" autofocus>
            </div>
            <div>
                <label for="password">Password:</label>
                <input type="password" id="untispass" name="password">
            </div>
            <div>
                <button onclick="untislogin()">Webuntis login</button>
                <span id="loginmessage"></span>
            </div>
        </div> <!-- #loginshizzle -->
        <button id="toggleSettings" disabled="true" onclick="toggleSettings()">â–¼</button>
        <div id="settings" hidden="true">
            <div>
                <label for="schoolyears">Schoolyear:</label>
                <select name="schoolyears" id="schoolyears" onchange="setTtLimits()"></select>
            </div>
            <div id="teacherLookup">
                Add a teacher.
                <div>
                    <label for="tlFirstName">First Name:</label>
                    <input id="tlFirstName" name="tlFirstName"> 
                </div>
                <div>
                    <label for="tlLastName">Last Name:</label>
                    <input id="tlLastName" name="tlLastName"> 
                </div>
                <div>
                    <label for="tlRemember">Remember:</label>
                    <input type="checkbox" name="tlRemember" id="tlRemember" checked="true">
                    <button onclick="teacherLookup()">Search</button>
                    <span id="tlMessage"></span>
                </div>
            </div>
            <div>
                <button onclick="untislogout()">Logout</button>
            </div>
        </div> <!-- #settings -->
        <div>
            <table id="timetable" class="timetable"></table>
        </div>
        <div>
            <input id="ttdate" type="date">
            <select id="ttteacher"></select>
            <select id="ttsymbol"></select>
            <button id="ttloadbtn" disabled="true" onclick="on_tt_button()">Load Timetable</button>
        </div>

        <script>
            window.addEventListener('pywebviewready', function() {
                pywebview.api.getConfig('untisUser').then(function(val) {
                    document.getElementById('untisuser').value = val;
                })
            })

            function toggleSettings() {
                let btn = document.getElementById('toggleSettings');
                let settings = document.getElementById('settings');
                if (settings.hidden) {
                    settings.hidden = false;
                    btn.textContent = 'â–²';
                } else {
                    settings.hidden = true;
                    btn.textContent = 'â–¼';
                }
            }

            function untislogin() {
                let user = document.getElementById('untisuser').value;
                let pass = document.getElementById('untispass').value;
                pywebview.api.untisLogin(user, pass).then(
                    function(success) {
                        if (success) {
                            document.getElementById('loginshizzle').hidden = true;
                            document.getElementById('loginmessage').innerText = '';
                            pywebview.api.loadSchoolyears().then(loadSchoolyears);
                            document.getElementById('toggleSettings').disabled = false;
                            pywebview.api.loadTeachers().then(loadTeachers);
                            document.getElementById('ttloadbtn').disabled = false;
                        } else {
                            document.getElementById('loginmessage').innerText = 'Login failed';
                        }
                    },
                    function(error) {
                        document.getElementById('loginmessage').innerText = error;
                    }
                )
            }

            function untislogout() {
                pywebview.api.untisLogout().then(
                    function() {
                        toggleSettings(); // Hide settings which we know are shown, because we get here
                        document.getElementById('loginshizzle').hidden = false;
                        document.getElementById('toggleSettings').disabled = true;
                        document.getElementById('ttloadbtn').disabled = true;
                    }
                );
            }

            function teacherLookup() {
                let firstName = document.getElementById('tlFirstName').value;
                let lastName = document.getElementById('tlLastName').value;
                let remember = document.getElementById('tlRemember').checked;
                pywebview.api.findTeacher(firstName, lastName, remember).then(function(res) {
                    let msgField = document.getElementById('tlMessage');
                    if (res) {
                        teachers[res.id] = res;
                        loadTeachers(teachers);
                        msgField.innerText = 'Teacher ' + res.name + ' was added';
                        document.getElementById('tlFirstName').value = '';
                        document.getElementById('tlLastName').value = '';
                    } else {
                        msgField.innerText = 'This teacher could not be found';
                    }
                });
            }

            let schoolyears;
            function loadSchoolyears(res) {
                schoolyears = res;
                let combo = document.getElementById('schoolyears');
                Object.keys(schoolyears).forEach(function(val, idx, arr) {
                    let o = document.createElement('option');
                    o.value = val;
                    o.text = schoolyears[val]['name'];
                    combo.add(o);
                    o.selected = true; // select the last added option
                });
                combo.onchange();
            }

            // callback function for schoolyears dropdown value change
            function setTtLimits() {
                let scyearsel = document.getElementById('schoolyears');
                let yearattrs = schoolyears[scyearsel.value];
                if (yearattrs) {
                    let ttdatesel = document.getElementById('ttdate');
                    ttdatesel.min = yearattrs['start'];
                    ttdatesel.max = yearattrs['end'];
                }
            }

            let teachers;
            function loadTeachers(res) {
                teachers = res;
                let combo = document.getElementById('ttteacher');
                let keys = Object.keys(res);
                keys.sort(function(a, b) {
                    return res[a].name > res[b].name ? 1 : -1;
                });
                while (combo.length > 0) {
                    combo.remove(combo.length - 1);
                }
                keys.forEach(function(val, idx, arr) {
                    let o = document.createElement('option');
                    o.value = val;
                    o.text = res[val]['name'];
                    combo.add(o);
                });
            }

            let symbols = {
                'unused': {
                    'circles': ['ðŸ”´', 'ðŸŸ ', 'ðŸŸ¡', 'ðŸŸ¢', 'ðŸ”µ', 'ðŸŸ£', 'ðŸŸ¤', 'âš«'],
                    'squares': ['ðŸŸ¥', 'ðŸŸ§', 'ðŸŸ¨', 'ðŸŸ©', 'ðŸŸ¦', 'ðŸŸª', 'ðŸŸ«', 'â¬›']
                },
                'used': {
                    'circles': [],
                    'squares': []
                }
            }
            // Set the contents of the symbols dropdown
            function loadSymbols() {
                let combo = document.getElementById('ttsymbol');
                while (combo.length > 0) {
                    combo.remove(combo.length - 1);
                }
                let unused = combo;
                let used;
                if (symbols.used.circles.length + symbols.used.squares.length > 0) {
                    if (unused = document.getElementById('ttsymbol-unused')) {
                        used = document.getElementById('ttsymbol-used');
                    } else {
                        unused = document.createElement('optgroup');
                        unused.label = 'Unused';
                        unused.id = 'ttsymbol-unused';
                        combo.add(unused);
                        used = document.createElement('optgroup');
                        used.label = 'Used';
                        used.id = 'ttsymbol-used';
                        combo.add(used);
                    }
                }
                symbols.unused.circles.forEach(function(val) { _loadSymbol(unused, val, 'unused', 'circles'); });
                symbols.unused.squares.forEach(function(val) { _loadSymbol(unused, val, 'unused', 'squares'); });
                symbols.used.circles.forEach(function(val) { _loadSymbol(used, val, 'used', 'circles'); });
                symbols.used.squares.forEach(function(val) { _loadSymbol(used, val, 'used', 'squares'); });
            }
            function _loadSymbol(container, val, used, collection) {
                let opt = document.createElement('option');
                opt.value = val;
                opt.text = val;
                opt.dataset.used = used;
                opt.dataset.collection = collection;
                container.appendChild(opt);
            }
            loadSymbols();

            // Return the selected symbol and moved it to the right 'used' list
            // if previously unused.
            function selectSymbol() {
                let combo = document.getElementById('ttsymbol');
                let selected = combo.options[combo.selectedIndex];
                if (selected.dataset.used == 'unused') {
                    let coll = selected.dataset.collection;
                    let symlist = symbols['unused'][coll];
                    let idx = symlist.findIndex(function(v) { return v == combo.value; })
                    symbols['used'][coll] = symbols['used'][coll].concat(symlist.splice(idx, 1));
                }
                let val = combo.value;
                loadSymbols();
                return val;
            }

            function createTimetable() { 
                var tt = document.getElementById('timetable');
                let tr = document.createElement('tr');
                tt.appendChild(tr);
                ['', 'Maandag', 'Dinsdag', 'Woesndag', 'Donderdag', 'Vrijdag'].forEach(function(val, idx, arr) {
                    let th = document.createElement('th');
                    th.innerText = val;
                    tr.appendChild(th);
                })
                for (let hour = 8; hour < 22; hour++) {
                    let tr = document.createElement('tr');
                    tr.id = 'tm_' + hour.toString();
                    tt.appendChild(tr);
                    for (let day = 0; day < 6; day++) {
                        let td = document.createElement('td');
                        td.id = 'tt_d' + day.toString() + '_tm' + hour.toString();
                        if (day == 0) {
                            td.innerText = hour.toString() + 'u';
                        }
                        tr.appendChild(td);
                    }
                }
            }
            createTimetable();

            // Add one element to the timetable
            function addTtEl(val, idx, ttable) {
                let cell_id = 'tt_d' + val.day.toString() + '_tm' + val.time.toString();
                let cell = document.getElementById(cell_id);
                let content = document.createElement('span');
                let el_class = ttable.tbltype + '_' + ttable.objid;
                content.className = el_class;
                content.innerText = ttable.symbol;
                let title = [];
                if (val.teachers.length) {
                    title.push('T: ' + teachers[val.teachers[0].id].name);
                }
                if (val.subjects.length) {
                    title.push('S: ' + val.subjects[0].long_name);
                }
                if (val.groups.length) {
                    title.push('G: ' + val.groups[0].name); // XXX need to use all groups
                }
                if (val.rooms.length) {
                    title.push('R: ' + val.rooms[0].name);
                }
                content.title = title.join(', ');
                cell.appendChild(content);
            }

            let x; // for debug
            // callback function for the Load Timetable button
            function loadTimetable(tt) {
                x = tt; // for debug
                tbl = {
                    'tbltype': tt.tbltype,
                    'objid': tt.objid,
                    'symbol': selectSymbol()
                };
                tt.table.forEach(function(val, idx, arr) { addTtEl(val, idx, tbl); });
            }

            function on_tt_button() {
                let ttdate = document.getElementById('ttdate').value;
                let ttteacher = document.getElementById('ttteacher').value;
                pywebview.api.getTimeTable('teacher', ttteacher, ttdate).then(loadTimetable);
            }
        </script>
    </body>
</html>