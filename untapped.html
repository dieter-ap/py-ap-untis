<html>
    <head>
        <title>Untapped</title>
        <style>
            div {
                padding: 5px;
            }
            table.timetable {
                border: solid 1px black;
                border-spacing: 0;
                width: 100%;
            }
            .timetable td,th {
                border: solid 1px;
            }
        </style>
    </head>
    <body>
        <div id="loginshizzle">
            <div>
                <label for="username">Username:</label>
                <input type="text" id="untisuser" name="username" autofocus>
            </div>
            <div>
                <label for="password">Password:</label>
                <input type="password" id="untispass" name="password">
            </div>
            <div>
                <button onclick="untislogin()">Webuntis login</button>
                <span id="loginmessage"></span>
            </div>
        </div> <!-- #loginshizzle -->
        <button id="toggleSettings" disabled="true" onclick="toggleSettings()">â–¼</button>
        <div id="settings" hidden="true">
            <div>
                <label for="schoolyears">Schoolyear:</label>
                <select name="schoolyears" id="schoolyears" onchange="setTtLimits()"></select>
            </div>
            <div>
                <button onclick="untislogout()">Logout</button>
            </div>
        </div> <!-- #settings -->
        <div>
            <table id="timetable" class="timetable"></table>
        </div>
        <div>
            <input id="ttdate" type="date">
            <input id="ttteacher" type="text" value="3817">
            <button id="ttloadbtn" disabled="true" onclick="on_tt_button()">Load Timetable</button>
        </div>

        <script>
            window.addEventListener('pywebviewready', function() {
                pywebview.api.getConfig('untisUser').then(function(val) {
                    document.getElementById('untisuser').value = val;
                })
            })

            function toggleSettings() {
                let btn = document.getElementById('toggleSettings');
                let settings = document.getElementById('settings');
                if (settings.hidden) {
                    settings.hidden = false;
                    btn.textContent = 'â–²';
                } else {
                    settings.hidden = true;
                    btn.textContent = 'â–¼';
                }
            }

            function untislogin() {
                let user = document.getElementById('untisuser').value;
                let pass = document.getElementById('untispass').value;
                pywebview.api.untisLogin(user, pass).then(
                    function(success) {
                        if (success) {
                            document.getElementById('loginshizzle').hidden = true;
                            document.getElementById('loginmessage').innerText = '';
                            pywebview.api.loadSchoolyears().then(loadSchoolyears);
                            document.getElementById('toggleSettings').disabled = false;
                            document.getElementById('ttloadbtn').disabled = false;
                        } else {
                            document.getElementById('loginmessage').innerText = 'Login failed';
                        }
                    },
                    function(error) {
                        document.getElementById('loginmessage').innerText = error;
                    }
                )
            }

            function untislogout() {
                pywebview.api.untisLogout().then(
                    function() {
                        toggleSettings(); // Hide settings which we know are shown, because we get here
                        document.getElementById('loginshizzle').hidden = false;
                        document.getElementById('toggleSettings').disabled = true;
                        document.getElementById('ttloadbtn').disabled = true;
                    }
                );
            }

            let schoolyears;
            function loadSchoolyears(res) {
                schoolyears = res;
                let combo = document.getElementById('schoolyears');
                Object.keys(schoolyears).forEach(function(val, idx, arr) {
                    let o = document.createElement('option');
                    o.value = val;
                    o.text = schoolyears[val]['name'];
                    combo.add(o);
                    o.selected = true; // select the last added option
                });
                combo.onchange();
            }

            // callback function for schoolyears dropdown value change
            function setTtLimits() {
                let scyearsel = document.getElementById('schoolyears');
                let yearattrs = schoolyears[scyearsel.value];
                if (yearattrs) {
                    let ttdatesel = document.getElementById('ttdate');
                    ttdatesel.min = yearattrs['start'];
                    ttdatesel.max = yearattrs['end'];
                }
            }

            function createTimetable() { 
                var tt = document.getElementById('timetable');
                let tr = document.createElement('tr');
                tt.appendChild(tr);
                ['', 'Maandag', 'Dinsdag', 'Woesndag', 'Donderdag', 'Vrijdag'].forEach(function(val, idx, arr) {
                    let th = document.createElement('th');
                    th.innerText = val;
                    tr.appendChild(th);
                })
                for (let hour = 8; hour < 22; hour++) {
                    let tr = document.createElement('tr');
                    tr.id = 'tm_' + hour.toString();
                    tt.appendChild(tr);
                    for (let day = 0; day < 6; day++) {
                        let td = document.createElement('td');
                        td.id = 'tt_d' + day.toString() + '_tm' + hour.toString();
                        if (day == 0) {
                            td.innerText = hour.toString() + 'u';
                        }
                        tr.appendChild(td);
                    }
                }
            }

            // Add one element to the timetable
            function addTtEl(val, idx, arr) {
                let col = val.day;
                let row = val.startTime / 100;
                let cell_id = 'tt_d' + col.toString() + '_tm' + row.toString();
                let cell = document.getElementById(cell_id);
                let content = document.createElement('span')
                let el_class = 'te_' + val.te[0].id; // XXX need to have this per timetable type
                content.className = el_class;
                content.innerText = 'ðŸŸ¢';
                content.title = 'L: ' + val.te[0].id + ', O: ' + val.su[0].id + ', G: ' + val.kl[0].id;
                cell.appendChild(content);
            }
            createTimetable();

            let x; // for debug
            // callback function for the Load Timetable button
            function loadTimetable(tt) {
                x = tt; // for debug
                tt.forEach(addTtEl);
            }

            function on_tt_button() {
                let ttdate = document.getElementById('ttdate').value;
                let ttteacher = document.getElementById('ttteacher').value;
                pywebview.api.getTeacherTable(ttteacher, ttdate).then(loadTimetable);
            }
        </script>
    </body>
</html>