<!DOCTYPE html>
<html>
    <head>
        <title>Untapped</title>
        <style>
            div {
                margin: 5px 0px;
            }
            #timetables div {
                background-color: whitesmoke;
                border-radius: 15px;
                padding: 10px;
            }
            table.timetable {
                border: solid 1px black;
                border-spacing: 0;
                width: 100%;
            }
            th {
                text-align: left;
            }
            .timetable td, .timetable th {
                border: solid 1px;
            }
            span.symbolGroup {
                border: solid 1px darkgray;
                border-radius: 5px;
                padding: 2px;
            }
            span.symbolGroup.active {
                background-color: lightgray;
            }
            input, select {
                margin: 5px 10px 0px 0px;
            }
            .closebutton {
                font-size: x-large;
                float: right;
            }
        </style>
    </head>
    <body>
        <datalist id="subjectList"></datalist>
        <datalist id="groupList"></datalist>
        <datalist id="teacherList"></datalist>
        <div id="loginshizzle">
            <div>
                <label for="username">Username:</label>
                <input type="text" id="untisuser" name="username" autofocus>
            </div>
            <div>
                <label for="password">Password:</label>
                <input type="password" id="untispass" name="password">
            </div>
            <div>
                <button onclick="untislogin()">Webuntis login</button>
                <span id="loginmessage"></span>
            </div>
        </div> <!-- #loginshizzle -->
        <button id="toggleSettings" disabled="true" hidden=true onclick="toggleSettings()">▼</button>
        <div id="settings" hidden="true">
            <div>
                <label for="schoolyears">Schoolyear:</label>
                <select name="schoolyears" id="schoolyears" onchange="setTtLimits(); fetchGroups()"></select>
            </div>
            <div>
                <button onclick="untislogout()">Logout</button>
            </div>
        </div> <!-- #settings -->
        
        <div id="timetables"></div>
        <div id="addContainer" hidden="true">
            <input id="ttdate" type="date">
            <button onclick="addTimetable()">New Timetable</button>
        </div>

        <script>
            window.addEventListener('pywebviewready', function() {
                pywebview.api.getConfig('untisUser').then(function(val) {
                    document.getElementById('untisuser').value = val;
                })
                pywebview.api.loadTeachers().then(function(res) {
                    loadData('teacher', res);
                })
            })

            function toggleSettings() {
                let btn = document.getElementById('toggleSettings');
                let settings = document.getElementById('settings');
                if (settings.hidden) {
                    settings.hidden = false;
                    btn.textContent = '▲';
                } else {
                    settings.hidden = true;
                    btn.textContent = '▼';
                }
            }

            function untislogin() {
                let user = document.getElementById('untisuser').value;
                let pass = document.getElementById('untispass').value;
                pywebview.api.untisLogin(user, pass).then(
                    function(success) {
                        if (success) {
                            document.getElementById('loginshizzle').hidden = true;
                            document.getElementById('loginmessage').innerText = '';
                            pywebview.api.loadSchoolyears().then(loadSchoolyears);
                            document.getElementById('toggleSettings').disabled = false;
                            document.getElementById('toggleSettings').hidden = false;
                            pywebview.api.getSubjects().then(function(res) { loadData('subject', res); });
                            //pywebview.api.getGroups().then(loadGroups); automatically when schoolyears are loaded
                            document.getElementById('addContainer').hidden = false;
                        } else {
                            document.getElementById('loginmessage').innerText = 'Login failed';
                        }
                    },
                    function(error) {
                        document.getElementById('loginmessage').innerText = error;
                    }
                )
            }

            function untislogout() {
                pywebview.api.untisLogout().then(
                    function() {
                        toggleSettings(); // Hide settings (we know they are shown, because we get here)
                        document.getElementById('loginshizzle').hidden = false;
                        document.getElementById('toggleSettings').disabled = true;
                        document.getElementById('ttloadbtn').disabled = true;
                    }
                );
            }

            let data = {};
            function loadData(dtype, newData) {
                data[dtype + 's'] = newData;
                let dl = document.getElementById(dtype + 'List');
                dl.querySelectorAll('option').forEach(function(c) { dl.removeChild(c) })
                newData.forEach(function(val) {
                    let opt = document.createElement('option');
                    if (val.name != val.longName) {
                        opt.value = val.name;
                    }
                    opt.innerText = val.longName;
                    dl.appendChild(opt);
                });
            }

            let schoolyears;
            function loadSchoolyears(res) {
                schoolyears = res;
                let combo = document.getElementById('schoolyears');
                Object.keys(schoolyears).forEach(function(val, idx, arr) {
                    let o = document.createElement('option');
                    o.value = val;
                    o.text = schoolyears[val]['name'];
                    combo.add(o);
                    o.selected = true; // select the last added option
                });
                combo.onchange();
            }

            // callback functions for schoolyears dropdown value change
            function setTtLimits() {
                let scyearsel = document.getElementById('schoolyears');
                let yearattrs = schoolyears[scyearsel.value];
                if (yearattrs) {
                    let ttdatesel = document.getElementById('ttdate');
                    ttdatesel.min = yearattrs['start'];
                    ttdatesel.max = yearattrs['end'];
                }
            }
            
            function fetchGroups() {
                let sy = document.getElementById('schoolyears').value;
                pywebview.api.getGroups(sy).then(function(res) { loadData('group', res); });
            }

            let timetables = {}; // all the existing tables
            let ttidx = 0; // last used table index

            // Set the contents of the symbols dropdown for a given table (index)
            function loadSymbols(tbl) {
                let combo = document.querySelector('#tmtblct' + tbl.toString() + ' .selectSymbol');
                while (combo.length > 0) {
                    combo.remove(combo.length - 1);
                }
                let unused = combo;
                let used;
                let symbols = timetables[tbl].symbols;
                if (symbols.find(function(el) { return el.used; })) {
                    if (unused = combo.querySelector('optgroup[label="Unused"]')) {
                        used = document.querySelector('optgroup[label="Used"]');
                    } else {
                        unused = document.createElement('optgroup');
                        unused.label = 'Unused';
                        combo.add(unused);
                        used = document.createElement('optgroup');
                        used.label = 'Used';
                        combo.add(used);
                    }
                }
                symbols.forEach(function(sym) {
                    let opt = document.createElement('option');
                    opt.innerText = sym.symbol;
                    if (sym.used) {
                        used.appendChild(opt);
                    } else {
                        unused.appendChild(opt);
                    }
                });
            }

            // Return the selected symbol and set its status to used
            function selectSymbol(tbl) {
                let symbols = timetables[tbl].symbols;
                let combo = document.querySelector('#tmtblct' + tbl.toString() + ' .selectSymbol');
                let sym = symbols.find(function (s) { return s.symbol == combo.value; });
                sym.used = true;
                loadSymbols(tbl);
                return sym.symbol;
            }

            function addTimetable() {
                ttidx += 1;
                let dt = document.getElementById('ttdate').value;
                timetables[ttidx] = {
                    'date': dt,
                    'symbols': [
                        '🔴', '🟠', '🟡', '🟢', '🔵', '🟣', '🟤', '⚫',
                        '🟥', '🟧', '🟨', '🟩', '🟦', '🟪', '🟫', '⬛',
                        '❤️', '🧡', '💛', '💚', '💙', '💜', '🤎', '🖤'
                    ].map(function(s) { return {'symbol': s, 'used': false}; })
                }
                var el_tables = document.getElementById('timetables');
                let ttd = document.createElement('div');
                ttd.id = 'tmtblct' + ttidx.toString();
                el_tables.appendChild(ttd);

                let tt = document.createElement('table');
                tt.id = 'tmtbl' + ttidx.toString();
                tt.className = 'timetable';
                ttd.appendChild(tt);

                let tr = document.createElement('tr');
                tt.appendChild(tr);
                pywebview.api.getDateFormats(dt, '%b', '%a %d').then(function(res) {
                    res.forEach(function(val, idx, arr) {
                        if (idx < 6) {
                            let th = document.createElement('th');
                            th.innerText = val;
                            tr.appendChild(th);
                        }
                    });
                });
                for (let hour = 8; hour < 22; hour++) {
                    let tr = document.createElement('tr');
                    tr.id = 'tm_' + ttidx.toString() + '_' + hour.toString();
                    tt.appendChild(tr);
                    for (let day = 0; day < 6; day++) {
                        let td = document.createElement('td');
                        td.id = 'tt_' + ttidx.toString() + '_d' + day.toString() + '_tm' + hour.toString();
                        if (day == 0) {
                            td.innerText = hour.toString() + 'u';
                        }
                        tr.appendChild(td);
                    }
                }

                let ltcd = document.createElement('div');
                ltcd.id = 'loadedTablesContainer' + ttidx.toString();
                ltcd.hidden = true;
                ttd.appendChild(ltcd);

                let ltct = document.createElement('table');
                ltcd.appendChild(ltct);
                let ltcb = document.createElement('tbody');
                ltcb.id = 'loadedTables' + ttidx.toString();
                ltct.appendChild(ltcb);

                let typesel = document.createElement('select');
                typesel.className = 'selectType';
                ['Subject', 'Group', 'Teacher'].forEach(function(label) {
                    let opt = document.createElement('option');
                    opt.innerText = label;
                    typesel.appendChild(opt);
                })
                typesel.onchange = _mkTypeSelHandler(ttidx);
                ttd.append(typesel);

                let tchsel = document.createElement('input');
                tchsel.className = 'selectTeacher';
                tchsel.setAttribute('list', 'teacherList');
                ttd.append(tchsel);

                let subsel = document.createElement('input');
                subsel.className = 'selectSubject';
                subsel.setAttribute('list', 'subjectList');
                ttd.append(subsel);

                let grpsel = document.createElement('input');
                grpsel.className = 'selectGroup';
                grpsel.setAttribute('list', 'groupList');
                ttd.append(grpsel);

                let symsel = document.createElement('select');
                symsel.className = 'selectSymbol';
                ttd.append(symsel);
                loadSymbols(ttidx);

                typesel.onchange();

                let loadbtn = document.createElement('button');
                loadbtn.innerText = 'Load Timetable';
                loadbtn.onclick = _mkBtnHandler(ttidx);
                ttd.append(loadbtn);

                let closebtn = document.createElement('span');
                closebtn.innerText = '☒';
                closebtn.className = 'closebutton';
                closebtn.title = 'Remove this timetable';
                closebtn.onclick = _mkCloseHandler(ttidx);
                ttd.append(closebtn);
            }
            function _mkTypeSelHandler(tbl) {
                // Create a function that will be called when a table type
                // is changed.
                let tablect = document.getElementById('tmtblct' + tbl.toString());
                return function(event) {
                    let typeSel = tablect.querySelector('select.selectType');
                    typeSel.querySelectorAll('option').forEach(function(opt) {
                        let optSel = tablect.querySelector('.select' + opt.value);
                        if (optSel) {
                            optSel.hidden = typeSel.value != opt.value;
                        }
                    })
                }
            }
            function _mkBtnHandler(tbl) {
                return function() { on_tt_button(tbl); }
            }
            function _mkCloseHandler(tbl) {
                return function() {
                    if (confirm('Are you sure you want to remove this table?')) {
                        let tblel = document.getElementById('tmtblct' + tbl.toString());
                        tblel.parentElement.removeChild(tblel);
                        delete timetables[tbl];
                    }
                }
            }

            function addLoadedTable(tbl, symbol, name) {
                let table = document.querySelector('#loadedTablesContainer' + tbl.toString() + ' tbody');
                let tr = document.createElement('tr');
                [symbol, name].forEach(function(val) {
                    let td = document.createElement('td');
                    td.innerText = val;
                    tr.appendChild(td);
                });
                //tr.dataset.objid = tbldata.objid;
                table.appendChild(tr);
                let ct = document.querySelector('#loadedTablesContainer' + tbl.toString());
                ct.hidden = false;
            }

            /* Add one element to the timetable
              tbl = table index in timetables, ttable = info for this time table
              val = one table entry
            */
            function addTtEl(tbl, ttable, val) {
                let cell_id = 'tt_' + tbl.toString() + '_d' + val.day.toString() + '_tm' + val.time.toString();
                let cell = document.getElementById(cell_id);
                let lesson_ct = cell.querySelector('span[data-lessonid="' + val.id.toString() + '"]');
                if (lesson_ct) {
                    lesson_ct.classList.add('symbolGroup');
                } else {
                    lesson_ct = document.createElement('span');
                    lesson_ct.dataset.lessonid = val.id;
                    lesson_ct.onclick = _mkToggleLessonActive(lesson_ct);
                    cell.appendChild(lesson_ct);
                }
                let content = document.createElement('span');
                //let el_class = ttable.tbltype + '_' + ttable.objid;
                //content.className = el_class;
                content.innerText = ttable.symbol;
                let title = [];
                if (val.teachers.length) {
                    let tid = val.teachers[0].id;
                    title.push('T: ' + val.teachers[0].name);
                }
                if (val.subjects.length) {
                    title.push('S: ' + val.subjects[0].long_name);
                }
                if (val.groups.length) {
                    title.push('G: ' + val.groups[0].name); // XXX need to use all groups
                }
                if (val.rooms.length) {
                    title.push('R: ' + val.rooms[0].name);
                }
                content.title = title.join(', ');
                lesson_ct.appendChild(content);
            }

            function _mkToggleLessonActive(el) {
                return function() {
                    let action;
                    if (el.classList.contains('active')) {
                        action = 'remove';
                    } else {
                        action = 'add';
                    }
                    el.classList[action]('active');
                    if (el.children.length == 1) {
                        el.classList[action]('symbolGroup');
                    }
                };
            } 

            let x; // for debug
            // callback function for the Load Timetable button
            function loadTimetable(tbl, queryRes, symbol) {
                x = queryRes; // for debug
                qInfo = {
                    'tbltype': queryRes.tbltype,
                    'objid': queryRes.objid,
                    'symbol': symbol
                };
                queryRes.table.forEach(function(val, idx, arr) { addTtEl(tbl, qInfo, val); });
            }

            function on_tt_button(tbl) {
                let ttdate = timetables[tbl].date;
                let tblct = document.getElementById('tmtblct' + tbl.toString());
                let tttype = tblct.querySelector('.selectType').value;
                let inputField = tblct.querySelector('.select' + tttype);
                let val = inputField.value;
                inputField.value = ''; // clear
                let dataList = data[tttype.toLowerCase() + 's'];
                let vdata = dataList.find(function(el) { return el.name == val; });
                if (tttype == 'Teacher' && !vdata) {
                    pywebview.api.findTeacher(val).then(function (res) {
                        if (res) {
                            dataList.push(res);
                            dataList.sort(function(a, b) { return a.name < b.name ? -1 : 1; })
                            loadData('teacher', dataList);
                            vdata = res;
                        }
                        getTimeTable(tbl, tttype.toLowerCase(), val, vdata, ttdate);
                    })
                } else {
                    getTimeTable(tbl, tttype.toLowerCase(), val, vdata, ttdate);
                }
            }

            function getTimeTable(tbl, type, value, queryData, date) {
                if (!queryData) {
                    alert(type + ' ' + value + ' was not found');
                    return;
                }
                let symbol = selectSymbol(tbl);
                pywebview.api.getTimeTable(type.toLowerCase(), queryData.id, date).then(
                    function(res) {
                        loadTimetable(tbl, res, symbol);
                        addLoadedTable(tbl, symbol, queryData.longName);
                    }
                )
            }
        </script>
    </body>
</html>